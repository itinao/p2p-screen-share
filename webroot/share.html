<!DOCTYPE HTML>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Share | Desktop Capture Share</title>
  <link rel="stylesheet" href="build/css/share.min.css" />
  <script type="text/javascript" src="vendors/polymer/platform/platform.js"></script>
</head>
<body unresolved>

<link rel="import" href="vendors/polymer/polymer/polymer.html"> 

<style>
core-toolbar {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #0041A2;
  color: #fff;
  font-size: 1.5em;
}
.video-content {
  position: absolute;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-transform: scale(0.8) translateY(3%);
}
peer-video {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
}
.content-animation {
  opacity: 0;
  -webkit-animation: cardEnter 0.75s ease-in-out 0.5s;
  -webkit-animation-fill-mode: both;
  -webkit-box-shadow: 0 10px 20px rgba(0, 0, 0, .19), 0 6px 6px rgba(0, 0, 0, .23);
}
.fullscreen {
-webkit-transition: transform 0.5s linear 0, background 0.3s linear 0.5s;
-webkit-transform: scale(1) translateY(0);
background: rgba(0, 0, 0, 0.8);
}
</style>

<link rel="import" href="vendors/polymer/core-toolbar/core-toolbar.html">
<link rel="import" href="vendors/polymer/core-icon-button/core-icon-button.html">
<core-toolbar class="tall">
  <span flex>Desktop Capture Share</span>
  <core-icon-button id="fullscreen-button" icon="fullscreen"></core-icon-button>
  <!-- TODO:
  <core-icon-button id="info-button" icon="info"></core-icon-button>
  -->
</core-toolbar>

<div id="video-content" class="video-content">
  <peer-video id="peer-video" style="display: none;" class="content-animation" host="screen-share-signaling.itinao.asia" port="8080" path="/share" debug="2"></peer-video>
</div>

<div id="loading" class="loading">
  <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
     <circle class="spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
  </svg>
</div>



<polymer-element name="peer-video" attributes="host port path debug">
  <template>
    <video id="video" height="100%"></video>
  </template>

  <script type="text/javascript" src="vendors/peerjs/peer.js"></script>
  <script type="text/javascript">
    Polymer('peer-video', {
  
      // PeerJSの接続config (default
      host: 'localhost',
      port: 8888,
      path: '/share',
      debug: 1,
  
      // PeerJS接続情報の保持
      peer: null,
      connections: {},
      connectionPeerId: null,
  
      onStreamCallback: null,

      ready: function() {
        this.connectionPeerId = location.search.replace(/^\?id\=/, '');
        this.peer = new Peer({host: this.host, port: this.port, path: this.path, debug: this.debug});
        this.peer.on('open', this.onOpen.bind(this));
        this.peer.on('error', this.onError.bind(this));
        this.peer.on('call', this.onCall.bind(this));
        this.peer.on('connection', this.onConnection.bind(this));
      },

      // media connectionの受信イベント
      onCall: function(mediaConnection) {
        mediaConnection.answer();
        mediaConnection.on('stream', this.onStream.bind(this));
      },

      // media connectionのstream追加通知イベント
      onStream: function(stream) {
        this.$.video.src = window.URL.createObjectURL(stream);
        this.$.video.play();
        this.onStreamCallback && this.onStreamCallback();
      },

      // PeerJS Serverへの接続完了イベント
      onOpen: function(id) {
        console.log("open: " + id);
        this.createConnection(this.connectionPeerId);
      },

      // PeerJS Serverへの接続失敗イベント 
      onError: function(error) {
        console.log(error);
      },

      // PeerJS Serverのコネクション完了イベント
      onConnection: function(connection) {
        console.log("connection: " + connection.peer);
        connection = this.addConnectionEvent(connection);
        this.connections[connection.peer] = connection;
      },
  
      // コネクション確立時に各種イベントをセットする
      addConnectionEvent: function(connection) {
        connection.on('open', this.onOpenFromPartner.bind(this, connection));
        connection.on('data', this.onDataFromPartner.bind(this, connection));
        connection.on('close', this.onCloseFromPartner.bind(this, connection));
        return connection;
      },

      // パートナーの接続イベント
      onOpenFromPartner: function(connection) {
        console.log('open partner: ' + connection.peer);
      },

      // パートナーから送られてきたデータの受信イベント
      onDataFromPartner: function(connection, data) {
        console.log(data);
      },

      // パートナーの切断イベント 
      onCloseFromPartner: function(connection) {
        console.log('close partner: ' + connection.peer);
      },
  
      // 接続処理
      createConnection: function(connectionId) {
        if (!connectionId) {
          return;
        }
        // TODO: この処理中にmedia connectionのエラーが発生するのを調べる
        var connection = this.peer.connect(connectionId, {
          label: 'captureShare',
          serialization: 'binary',
          reliable: true,
          metadata: {message: 'new connection'}
        });
        connection = this.addConnectionEvent(connection);
        this.connections[connectionId] = connection;
      }
    });
  </script>
</polymer-element>


<script>
document.addEventListener('polymer-ready', function(e) {
  var videoContent = window['video-content'];
  var videoContentDefaultClass = videoContent.className;
  var fullscreenButton = window['fullscreen-button'];
  // フルスクリーン化
  fullscreenButton.addEventListener('click', function(event) {
    videoContent.classList.add("fullscreen")
  });
  // フルスクリーン化 解除
  videoContent.addEventListener('click', function(event) {
    videoContent.classList.remove("fullscreen")
  });

  var peerVideo = window['peer-video'];
  var loading = window['loading'];
  peerVideo.onStreamCallback = function() {
    setTimeout(function() {// loadしてる感を出すため300ms
      loading.remove();
      peerVideo.style.display = '';
    }, 300);
  };
});
</script>



</body>
</html>
