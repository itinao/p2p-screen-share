<!DOCTYPE HTML>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title></title>
<!--
  <script type="text/javascript" src="vendors/polymer/platform/platform.js"></script>
-->
</head>
<body>

<style type="text/css">
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}


.loading {
  position: absolute;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(156, 154, 154, 0.3);
}

// This is just to center the spinner
.spinner {
  -webkit-animation: rotator 1.4s linear infinite;
}
@-webkit-keyframes rotator {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(270deg); }
}
.spinner-path {
  stroke-dasharray: 187;
  stroke-dashoffset: 0;
  transform-origin: center;
  -webkit-animation: dash 1.4s ease-in-out infinite, colors 5.6s ease-in-out infinite;
}
@-webkit-keyframes colors {
  0% { stroke: #4285F4; }
  25% { stroke: #DE3E35; }
  50% { stroke: #F7C223; }
  75% { stroke: #1B9A59; }
  100% { stroke: #4285F4; }
}
@-webkit-keyframes dash {
 0% { stroke-dashoffset: 187; }
 50% {
   stroke-dashoffset: 46;
   transform:rotate(135deg);
 }
 100% {
   stroke-dashoffset: 187;
   transform:rotate(450deg);
 }
}

.share-wrapper {
  position: absolute;
  width: 100%;
  height: 100%;
}
video {
  width: 100%;
  height: 100%;
  background: #ff7;
}
</style>



<div class="share-wrapper">
  <video id="share-stream"></video>
</div>

<div class="js-loading loading">
  <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
     <circle class="spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
  </svg>
</div>





<script type="text/javascript" src="vendors/peerjs/peer.js"></script>
<script type="text/javascript" src="js/class.js"></script>

<script type="text/javascript">
var AppPeer = Class.extend({
  // PeerJSの接続config (default
  host: 'screen-share-signaling.itinao.asia',
  port: 8080,
  path: '/share',
  debug: 2,

  // PeerJS接続情報の保持
  peer: null,
  connections: {},
  hostPeerId: null,

  shareFile: 'share.html',
  shareUrl: '',

  init: function() {
    this.hostPeerId = location.search.replace(/^\?id\=/, '');
    this.peer = new Peer({host: this.host, port: this.port, path: this.path, debug: this.debug});
    this.peer.on('open', this.onOpen.bind(this));
    this.peer.on('error', this.onError.bind(this));
    this.peer.on('call', this.onCall.bind(this));
    this.peer.on('connection', this.onConnection.bind(this));
  },

  setShareUrl: function(id) {
    this.shareUrl = location.origin + location.pathname + this.shareFile + '?id=' + id;
  },

  onOpen: function(id) {
    console.log("open: " + id);
    this.setShareUrl(id);
    this.createConnection(this.hostPeerId);
  },

  onCall: function(mediaConnection) {
    mediaConnection.answer();
    mediaConnection.on('stream', function(stream) {
      var shareStream = document.querySelector('#share-stream');
      shareStream.src = window.URL.createObjectURL(stream);
      shareStream.play();
    }.bind(this));
  },

  onError: function(error) {
    console.log(error);
  },

  onConnection: function(connection) {
    console.log("connection: " + connection.peer);
    connection = this.addConnectionEvent(connection);
    this.connections[connection.peer] = connection;
  },

  // コネクション確立時に各種イベントをセットする
  addConnectionEvent: function(connection) {
    connection.on('open', this.onOpenFromPartner.bind(this, connection));
    connection.on('data', this.onDataFromPartner.bind(this, connection));
    connection.on('close', this.onCloseFromPartner.bind(this, connection));
    return connection;
  },

  onOpenFromPartner: function(connection) {
    console.log('open partner: ' + connection.peer);
    //TODO:  これを使ってgrowlなどで接続を通知するとよさそう
    //console.log(connection.metadata.message);
  },

  onDataFromPartner: function(connection, data) {
    console.log(data);
  },

  onCloseFromPartner: function(connection) {
    console.log('close partner: ' + connection.peer);
  },

  // 接続処理
  createConnection: function(connectionId) {
    if (!connectionId) {
      return;
    }
    // TODO: この処理中にmedia connectionのエラーが発生するのを調べる
    var connection = this.peer.connect(connectionId, {
      label: 'captureShare',
      serialization: 'binary',
      reliable: true,
      metadata: {message: 'new connection!!'}
    });
    connection = this.addConnectionEvent(connection);
    this.connections[connectionId] = connection;


setTimeout(function() {// loadしてる感を出すため1000ms
  var loading = document.querySelector('.js-loading');
  loading.remove();
}, 1000);
  },
});


var appPeer = new AppPeer();

</script>

<!--

<link rel="import" href="vendors/polymer/core-icons/core-icons.html">
<link rel="import" href="vendors/polymer/paper-item/paper-item.html">
<link rel="import" href="vendors/polymer/paper-button/paper-button.html">

<capture-share host="localhost" port="9000" path="/share" debug="2">
</capture-share>


<polymer-element name="capture-share" attributes="host port path debug">
<template>
<style type="text/css">
</style>
  <video id="share-stream"></video>
</template>

<script type="text/javascript" src="vendors/peerjs/peer.js"></script>
<script type="text/javascript">
  Polymer('capture-share', {

    // PeerJSの接続config (default
    host: 'localhost',
    port: 8888,
    path: '/capture-share',
    debug: 1,

    // PeerJS接続情報の保持
    peer: null,
    connections: {},
    hostPeerId: null,

    shareFile: 'share.html',
    shareUrl: '',

    ready: function() {
      this.hostPeerId = location.search.replace(/^\?id\=/, '');
      this.peer = new Peer({host: this.host, port: this.port, path: this.path, debug: this.debug});
      this.peer.on('open', this.onOpen.bind(this));
      this.peer.on('error', this.onError.bind(this));
      this.peer.on('call', this.onCall.bind(this));
      this.peer.on('connection', this.onConnection.bind(this));
    },

    setShareUrl: function(id) {
      this.shareUrl = location.origin + location.pathname + this.shareFile + '?id=' + id;
    },

    onOpen: function(id) {
      console.log("open: " + id);
      this.setShareUrl(id);
      this.createConnection(this.hostPeerId);
    },

    onCall: function(mediaConnection) {
      mediaConnection.answer();
      mediaConnection.on('stream', function(stream) {
        this.$['share-stream'].src = window.URL.createObjectURL(stream);
        this.$['share-stream'].play();
      }.bind(this));
    },

    onError: function(error) {
      console.log(error);
    },

    onConnection: function(connection) {
      console.log("connection: " + connection.peer);
      connection = this.addConnectionEvent(connection);
      this.connections[connection.peer] = connection;
    },

    // コネクション確立時に各種イベントをセットする
    addConnectionEvent: function(connection) {
      connection.on('open', this.onOpenFromPartner.bind(this, connection));
      connection.on('data', this.onDataFromPartner.bind(this, connection));
      connection.on('close', this.onCloseFromPartner.bind(this, connection));
      return connection;
    },

    onOpenFromPartner: function(connection) {
      console.log('open partner: ' + connection.peer);
      //TODO:  これを使ってgrowlなどで接続を通知するとよさそう
      //console.log(connection.metadata.message);
    },

    onDataFromPartner: function(connection, data) {
      console.log(data);
    },

    onCloseFromPartner: function(connection) {
      console.log('close partner: ' + connection.peer);
    },

    // 接続処理
    createConnection: function(connectionId) {
      if (!connectionId) {
        return;
      }
      // TODO: この処理中にmedia connectionのエラーが発生するのを調べる
      var connection = this.peer.connect(connectionId, {
        label: 'captureShare',
        serialization: 'binary',
        reliable: true,
        metadata: {message: 'new connection!!'}
      });
      connection = this.addConnectionEvent(connection);
      this.connections[connectionId] = connection;
    },

  });
</script>
</polymer-element>
-->


</body>
</html>
