<!DOCTYPE HTML>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Share | Desktop Capture Share</title>
  <link rel="stylesheet" href="build/css/share.min.css" />
  <script type="text/javascript" src="vendors/polymer/platform/platform.js"></script>
</head>
<body>

<link rel="import" href="vendors/polymer/polymer/polymer.html"> 


<div class="share-wrapper">
  <div class="share-header">Desktop Capture Share</div>
  <peer-video id="js-peer-video" style="display: none;" class="content-animation" host="screen-share-signaling.itinao.asia" port="8080" path="/share" debug="2"></peer-video>
</div>

<div class="js-loading loading">
  <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
     <circle class="spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
  </svg>
</div>



<polymer-element name="peer-video" attributes="host port path debug">
  <template>
    <video id="video" height="100%"></video>
  </template>

  <script type="text/javascript" src="vendors/peerjs/peer.js"></script>
  <script type="text/javascript">
    Polymer('peer-video', {
  
      // PeerJSの接続config (default
      host: 'localhost',
      port: 8888,
      path: '/share',
      debug: 1,
  
      // PeerJS接続情報の保持
      peer: null,
      connections: {},
      connectionPeerId: null,
  
      ready: function() {
        this.connectionPeerId = location.search.replace(/^\?id\=/, '');
        this.peer = new Peer({host: this.host, port: this.port, path: this.path, debug: this.debug});
        this.peer.on('open', this.onOpen.bind(this));
        this.peer.on('error', this.onError.bind(this));
        this.peer.on('call', this.onCall.bind(this));
        this.peer.on('connection', this.onConnection.bind(this));
      },

      // media connectionの受信イベント
      onCall: function(mediaConnection) {
        mediaConnection.answer();
        mediaConnection.on('stream', this.onStream.bind(this));
      },

      // media connectionのstream追加通知イベント
      onStream: function(stream) {
        this.$.video.src = window.URL.createObjectURL(stream);
        this.$.video.play();

setTimeout(function() {// loadしてる感を出すため1000ms
  var loading = document.querySelector('.js-loading');
  loading.remove();

  var shareStream = document.querySelector('#js-peer-video');
  shareStream.style.display = '';
}, 300);
      },

      // PeerJS Serverへの接続完了イベント
      onOpen: function(id) {
        console.log("open: " + id);
        this.createConnection(this.connectionPeerId);
      },

      // PeerJS Serverへの接続失敗イベント 
      onError: function(error) {
        console.log(error);
      },

      // PeerJS Serverのコネクション完了イベント
      onConnection: function(connection) {
        console.log("connection: " + connection.peer);
        connection = this.addConnectionEvent(connection);
        this.connections[connection.peer] = connection;
      },
  
      // コネクション確立時に各種イベントをセットする
      addConnectionEvent: function(connection) {
        connection.on('open', this.onOpenFromPartner.bind(this, connection));
        connection.on('data', this.onDataFromPartner.bind(this, connection));
        connection.on('close', this.onCloseFromPartner.bind(this, connection));
        return connection;
      },

      // パートナーの接続イベント
      onOpenFromPartner: function(connection) {
        console.log('open partner: ' + connection.peer);
      },

      // パートナーから送られてきたデータの受信イベント
      onDataFromPartner: function(connection, data) {
        console.log(data);
      },

      // パートナーの切断イベント 
      onCloseFromPartner: function(connection) {
        console.log('close partner: ' + connection.peer);
      },
  
      // 接続処理
      createConnection: function(connectionId) {
        if (!connectionId) {
          return;
        }
        // TODO: この処理中にmedia connectionのエラーが発生するのを調べる
        var connection = this.peer.connect(connectionId, {
          label: 'captureShare',
          serialization: 'binary',
          reliable: true,
          metadata: {message: 'new connection'}
        });
        connection = this.addConnectionEvent(connection);
        this.connections[connectionId] = connection;
      }
    });
  </script>
</polymer-element>



<!--
<div class="share-wrapper">
  <div class="share-header">Desktop Capture Share</div>
  <video id="share-stream" class="content-animation" style="display: none;"></video>
</div>

<div class="js-loading loading">
  <svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
     <circle class="spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
  </svg>
</div>

<script type="text/javascript" src="vendors/peerjs/peer.js"></script>
<script type="text/javascript" src="js/class.js"></script>
-->

<!--
<script type="text/javascript">
var AppPeer = Class.extend({
  // PeerJSの接続config (default
  host: 'screen-share-signaling.itinao.asia',
  port: 8080,
  path: '/share',
  debug: 2,

  // PeerJS接続情報の保持
  peer: null,
  connections: {},
  hostPeerId: null,

  shareFile: 'share.html',
  shareUrl: '',

  init: function() {
    this.hostPeerId = location.search.replace(/^\?id\=/, '');
    this.peer = new Peer({host: this.host, port: this.port, path: this.path, debug: this.debug});
    this.peer.on('open', this.onOpen.bind(this));
    this.peer.on('error', this.onError.bind(this));
    this.peer.on('call', this.onCall.bind(this));
    this.peer.on('connection', this.onConnection.bind(this));
  },

  setShareUrl: function(id) {
    this.shareUrl = location.origin + location.pathname + this.shareFile + '?id=' + id;
  },

  onOpen: function(id) {
    console.log("open: " + id);
    this.setShareUrl(id);
    this.createConnection(this.hostPeerId);
  },

  onCall: function(mediaConnection) {
    mediaConnection.answer();
    mediaConnection.on('stream', function(stream) {
      var shareStream = document.querySelector('#share-stream');
      shareStream.src = window.URL.createObjectURL(stream);
      shareStream.play();
    }.bind(this));
  },

  onError: function(error) {
    console.log(error);
  },

  onConnection: function(connection) {
    console.log("connection: " + connection.peer);
    connection = this.addConnectionEvent(connection);
    this.connections[connection.peer] = connection;
  },

  // コネクション確立時に各種イベントをセットする
  addConnectionEvent: function(connection) {
    connection.on('open', this.onOpenFromPartner.bind(this, connection));
    connection.on('data', this.onDataFromPartner.bind(this, connection));
    connection.on('close', this.onCloseFromPartner.bind(this, connection));
    return connection;
  },

  onOpenFromPartner: function(connection) {
    console.log('open partner: ' + connection.peer);
    //TODO:  これを使ってgrowlなどで接続を通知するとよさそう
    //console.log(connection.metadata.message);
  },

  onDataFromPartner: function(connection, data) {
    console.log(data);
  },

  onCloseFromPartner: function(connection) {
    console.log('close partner: ' + connection.peer);
  },

  // 接続処理
  createConnection: function(connectionId) {
    if (!connectionId) {
      return;
    }
    // TODO: この処理中にmedia connectionのエラーが発生するのを調べる
    var connection = this.peer.connect(connectionId, {
      label: 'captureShare',
      serialization: 'binary',
      reliable: true,
      metadata: {message: 'new connection!!'}
    });
    connection = this.addConnectionEvent(connection);
    this.connections[connectionId] = connection;


setTimeout(function() {// loadしてる感を出すため1000ms
  var loading = document.querySelector('.js-loading');
  loading.remove();

  var shareStream = document.querySelector('#share-stream');
  shareStream.style.display = '';
}, 1000);
  },
});


var appPeer = new AppPeer();

</script>

-->

<!--

<link rel="import" href="vendors/polymer/core-icons/core-icons.html">
<link rel="import" href="vendors/polymer/paper-item/paper-item.html">
<link rel="import" href="vendors/polymer/paper-button/paper-button.html">

<capture-share host="localhost" port="9000" path="/share" debug="2">
</capture-share>


<polymer-element name="capture-share" attributes="host port path debug">
<template>
<style type="text/css">
</style>
  <video id="share-stream"></video>
</template>

<script type="text/javascript" src="vendors/peerjs/peer.js"></script>
<script type="text/javascript">
  Polymer('capture-share', {

    // PeerJSの接続config (default
    host: 'localhost',
    port: 8888,
    path: '/capture-share',
    debug: 1,

    // PeerJS接続情報の保持
    peer: null,
    connections: {},
    hostPeerId: null,

    shareFile: 'share.html',
    shareUrl: '',

    ready: function() {
      this.hostPeerId = location.search.replace(/^\?id\=/, '');
      this.peer = new Peer({host: this.host, port: this.port, path: this.path, debug: this.debug});
      this.peer.on('open', this.onOpen.bind(this));
      this.peer.on('error', this.onError.bind(this));
      this.peer.on('call', this.onCall.bind(this));
      this.peer.on('connection', this.onConnection.bind(this));
    },

    setShareUrl: function(id) {
      this.shareUrl = location.origin + location.pathname + this.shareFile + '?id=' + id;
    },

    onOpen: function(id) {
      console.log("open: " + id);
      this.setShareUrl(id);
      this.createConnection(this.hostPeerId);
    },

    onCall: function(mediaConnection) {
      mediaConnection.answer();
      mediaConnection.on('stream', function(stream) {
        this.$['share-stream'].src = window.URL.createObjectURL(stream);
        this.$['share-stream'].play();
      }.bind(this));
    },

    onError: function(error) {
      console.log(error);
    },

    onConnection: function(connection) {
      console.log("connection: " + connection.peer);
      connection = this.addConnectionEvent(connection);
      this.connections[connection.peer] = connection;
    },

    // コネクション確立時に各種イベントをセットする
    addConnectionEvent: function(connection) {
      connection.on('open', this.onOpenFromPartner.bind(this, connection));
      connection.on('data', this.onDataFromPartner.bind(this, connection));
      connection.on('close', this.onCloseFromPartner.bind(this, connection));
      return connection;
    },

    onOpenFromPartner: function(connection) {
      console.log('open partner: ' + connection.peer);
      //TODO:  これを使ってgrowlなどで接続を通知するとよさそう
      //console.log(connection.metadata.message);
    },

    onDataFromPartner: function(connection, data) {
      console.log(data);
    },

    onCloseFromPartner: function(connection) {
      console.log('close partner: ' + connection.peer);
    },

    // 接続処理
    createConnection: function(connectionId) {
      if (!connectionId) {
        return;
      }
      // TODO: この処理中にmedia connectionのエラーが発生するのを調べる
      var connection = this.peer.connect(connectionId, {
        label: 'captureShare',
        serialization: 'binary',
        reliable: true,
        metadata: {message: 'new connection!!'}
      });
      connection = this.addConnectionEvent(connection);
      this.connections[connectionId] = connection;
    },

  });
</script>
</polymer-element>
-->



<script>
window.addEventListener('polymer-ready', function(e) {
console.log("aba");
});
</script>



</body>
</html>
